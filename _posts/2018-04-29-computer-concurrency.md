---
layout: post
title: '深入理解计算机系统-并发'
subtitle: '读书笔记系列深入理解计算机系统之并发'
date: 2018-04-29
categories: 计算机系统
author: yates
cover: ''
tags: 计算机系统
---

现代操作系统提供三种基本构造并发程序的方法

- 进程，每个逻辑流都是一个进程，由**内核调度**和维护，而且每个进程有**独立的虚拟地址空间**，如果进程间通信，控制流必须使用某种显式的进程间通信（IPC）机制
- I/O多路复用，应用程序在一个**进程上下文中显式调度自己逻辑流**，逻辑流模型化状态机，数据到达文件描述符后，主程序先是从一个状态切换为另外一个状态，因为在一个进程中，所以所有流**共享同一个地址空间**。
- 线程，线程运行在一个单一进程上下文中的逻辑流，**内核进行调度**,而且共享同一个虚拟地址空间

每个线程都有自己的线程上下文，包括唯一的整数线程ID，栈，栈指针，程序计数器，寄存器，条件码，同时共享统一进程下的整个虚拟地址空间

每个进程开始都是**单一线程**，称为**主线程**，某一时刻，主线程创建一个**对等线程**，cpu时间片在线程间切换，线程上下文切换**开销小于进程**上下文切换的，而且不像进程那样有严格的**父子层次**关系，所有跟一个进程有关的线程组成一个**对等线程池**，独立于其他线程创建的线程。一个线程可以**杀死**他任何的对等线程，或**等待**它的任意对等线程终止。对等线程读写相同**共享数据**

任何一个时间点上，线程是**可结合或可分离**的，一个可结合的线程能够被其他线程收回和杀死，分离的线程不能被其他现场回收或杀死，内存资源只有在它终止时系统自动释放。

共享变量的互斥操作通常使用**信号量**来进行
- P（s）：如果s信号量非零。-1，并立即返回；如果为0则挂起
- V（s）：对s信号量加1，如果任何信号阻塞在P操作等待s变为非0，那么v重启这些线程中一个，完成P操作对s信号量-1

因为S信号量值总为0或1，这种依靠信号量保护共享变量的叫做二元信号量。P操作进行互斥锁加锁，V操作进行互斥锁解锁

**信号量**另外一个作用是调度共享资源的访问，比如生产者-消费者，读-写问题

**线程不安全函数**
- 不保护共享变量的函数，未保护全局变量的函数变成线程安全的，比较容易，使用类似P和V同步操作保护共享变量
- 保持跨越多个调用的状态函数，比如伪随机数生成器，这类想让其线程安全只有重写
- 返回指向静态变量的指针的函数，这类想让其线程安全**重写或加锁-复制技术（在每一个调用位置，对互斥锁加锁，将函数返回结果复制到一个私有的内存位置，然后解锁）**
- 调用线程不安全函数的函数，重写