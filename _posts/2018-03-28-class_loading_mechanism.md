---
layout: post
title: 'jvm之类加载机制'
subtitle: '类加载机制'
date: 2018-03-28
categories: jvm
author: yates
cover: ''
tags: jvm
---

# 前言
在java语言里面，jvm把类的数据从class文件加载到内存，并对数据进行校验，转换解析，初始化；而在类型的加载，连接，初始化过程都是在程序运行期间完成的，这种方式提高了应用程序的灵活性。

类的生命周期
![此处输入图片的描述](http://pev96mxgw.bkt.clouddn.com/img/2018-03-19-jvm/35.png)
整个过程除了解析阶段，其他阶段都是相互交叉混合的执行，通常会在一个阶段执行过程中调用，激活另一个阶段

**必须立即对类进行“初始化”情况**
jvm规范规定下面几种情况必须立即对类进行初始化

- 遇到new，getstatic，putstatic，invokestatic这四条指令时，如果类未初始化则进行初始化；**代码场景**：new 关键字实例化对象；读取设置一个static字段（同时final，static修饰常量外，final修饰常量在编译阶段就把放入常量池中了），调用一个static修饰方法
- 使用反射对类进行反射调用的时候
- 对子类的初始化必先对父类进行初始化
- 虚拟机启动，执行程序入口方法类先初始化
- 当使用java动态特性，使用methodHandle实例进行方法入参调用时，代表的引用后面的类要先于使用前得到初始化

接口的初始化大致和类一致，在对父接口初始化的时候，不要求父接口全部完成初始化，只是在真正使用到了父接口的时候才会初始化。

### 加载
加载过程分为三个过程

- 通过一个类的全限定名获取定义此类的二进制字节流。
- 将这个字节流代表的静态存储结构转化为方法区运行时结构
- 在内存中生成一个代表这个类的class对象，作为方法区这个类各种数据的访问入口

第一步，获取二进制流可以通过很多方式进行获取，jar，war，ear包，网络，代理都可以获取

数组类型类加载时，如果组件类型是引用类型，则会使用该组件类型的类加载器进行加载；如果是基本类型，则会使用引导类加载器进行加载

### 验证
Java虚拟机只与Class文件这种特定的二进制文件格式所关联，使用java语言编写代码会在编译的时候对数组边界，类型转换，跳转等代码进行验证，但是如果是采用其他语言编写，编译成class文件就有可能没有经过一定的验证，造成载入系统奔溃的代码。

主要验证动作

- 文件格式验证，验证字节流是否符合class文件格式的规范，并且能被当前版本虚拟机处理。详见[java类文件结构](http://muyibeyond.cn/2018/03/12/calss-structure.html)
- 元数据验证，对字节码描述的信息进行语义分析，使其符合java语言规范的要求，是否可继承，抽象类格式，接口格式等等。
- 字节码验证，通过数据流和控制流，分析程序的语义是否合法，符合逻辑，比如跳转区域，存取值类型。
- 符号引用验证，发生在虚拟机将符号引用转换为直接引用时，对自身类以外的信息进行匹配性校验（符号引用是否找得到对应类，引用字段，方法是否在对应类中有定义以及访问标志是否合法）

### 准备
主要是为类变量分配内存并初始化值，这里指的初始化是指基本类型的初始化，都是该数据类型零值。（final修饰常量为指定的常量值）

### 解析
主要是将常量池中符号引用转为直接引用。