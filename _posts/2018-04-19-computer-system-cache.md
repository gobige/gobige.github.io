---
layout: post
title: '深入理解计算机系统-高速缓存器'
subtitle: '读书笔记系列深入理解计算机系统之高速缓存'
date: 2018-04-19
categories: 计算机系统
author: yates
cover: ''
tags: 计算机系统
---

## 前言
CPU性能和内存访问速度差距不断拉大，CPU cache被加入到CPU中，指令，数据会被加入到L1~L3中。大多数情况，CPU只需要访问Cache就能拿到数据，无需访问内存。

## 高速缓存存储器
早期计算机，存储结构就三层，cpu寄存器，DRAM主存储器和磁盘存储。为了缓和cpu和主存之间的读写时间差距，在他们之间出现了SRAM高速缓存称为L1，之后又出现了L2，L3。

### 高速缓存的结构和存取机制
每个存储器地址有m位，形成2的m次方个地址；分为S个高速缓存组的数组；每个组有E个高速缓存行；每行由B字节数据块组成，一个有效位标识这个行是否有意义的信息，t个标记位标识存储在这个高速缓存行中的块。

高速缓存结构可以用元组（S,E,B,M）描述，**高速缓存大小C指所有块大小的和**，不包括标记位和有效位

### 直接映射高速缓存
直接映射的策略，确保每一个内存块地址，始终映射到CPU Cache地址，地址通常用mod运算实现。2的m次方在取模的时候，可直接取地址**低N位**，得到**cache line**地址。

**缓存块**

- **组标记**：存储一个**组标记**表示当前存储缓存块数据对应内存块。缓存块本身地址表示内存块地址低N位，对应**组标记只需记录剩余高N位信息**
- **有效位**：标记对应缓存块中数据是否有效
- **数据**：从主内存加载来实际存放的数据
- **偏移量**：访问数据时，定位对应字的位置偏移量

![](https://yatesblog.oss-cn-shenzhen.aliyuncs.com/img/computer-system-Perspective/51.png)

![此处输入图片的描述](http://yatesblog.oss-cn-shenzhen.aliyuncs.com/img/computer-system-Perspective/19.png)

CPU获取数据流程

- 组选择，高速缓存**从w字地址抽取s个组索引位**，索引位代表到达数组的索引。
- 行匹配，选择组i后，接下来确认是否有字w的副本在组i的行中，通过有效位确定标记和块中的位是有意义的，然后用**w地址汇总的标记位**与行标记位进行匹配，得到w的副本是否存储在这个行中，得到缓存命中。如果有效位没有设置或标记位不匹配，得到缓存不命中。
- 字选择，通过上述步骤，我们知道w在行中某个块中，这时需要确定存储字的块从哪儿开始，我们把块看出一个字节的数组，通过w字的块偏移得到块数组的一个索引


每个组的高速缓存行只有一行。当cpu执行读内存字w指令，首先向L1请求这个字，如果L1中有w的副本，直接返回给cpu，否则**缓存不命中**，L1向内存请求包含w的块的副本，请求块获取达到，存储在一个高速缓存行中，并返回给cpu字w，整个过程分为三步**1组选择2行匹配3字抽取**

如果缓存不命中，那么需要从下一级存储中获取被请求的块，然后将新块存储在组索引位指示组的一个高速缓存行中，如果组中已有行都是有效高速缓存行，就会进行替代。

- 冲突不命中，多次交替的缓存不命中导致缓存行不断被覆盖，比如对块x和y的引用交替加载到组0，每一个迭代引用都无法得到对应缓存，这种被称为**抖动**的情况，即**高速缓存反复地加载和驱逐相同高速缓存块的组**

### 组相连高速缓存
每个组有多于一个的高速缓存行，在进行行匹配时检查多个行标记位和有效位
### 全相连高速缓存
只包含一个组，但每个组有多个高速缓存行

## 编写高速缓存友好代码
- 让最常见情况允许得快。程序把大部分时间花在少量核心函数，这些函数把大部分时间花在少量循环上
- 经历减少循环内部缓存不命中数量
- 对局部变量的反复引用是好的，提高了时间局部性
- 步长为1的引用模式是好的，提高了空间局部性