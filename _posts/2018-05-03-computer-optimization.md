---
layout: post
title: '深入理解计算机系统-处理器体系结构'
subtitle: '读书笔记系列深入理解计算机系统之处理器体系结构'
date: 2018-05-3
categories: 计算机系统
author: yates
cover: ''
tags: 计算机系统
---

## 前言
现代计算机系统只限于机器语言程序级，处理器必须执行一系列指令，一个处理器支持的指令和指令的字节级编码称为它的指令集体系结构(ISA)，不同厂商都有不同的处理器家族。

## 编写高效的程序
- 必须选择适当的算法和数据结构
- 必须编写出编译器能够有效优化以转换为高效可执行代码的源代码
- 针对处理运算量特别大的计算，将一个任务分为多个部分，这些部分在多核和多处理器的某种组合上并行计算。


**编译器妨碍化的因素**
程序行为中严重依赖于执行环境的方面
例如对于两个指针p和q的数据进行两次相加，计算值依赖于p和q是否指向内存中同一个位置，编译器不能确定时，就假设什么情况都有肯能，限制优化策略
同样的还有方法重复调用的时候等等

![此处输入图片的描述](http://yatesblog.oss-cn-shenzhen.aliyuncs.com/img/computer-system-Perspective/35.png)

程序优化第一步，消除不必要的工作，让代码尽可能有效的执行所期望的任务。包括消除不必要的函数调用，条件测试和内存引用。
第二步，利用处理器提供指令级并行能力，

编译器会很小心的对程序只使用安全的优化，对于程序可能会遇到的所有可能情况，优化后程序和未优化版本有一样的行为。

- CPE：每元素周期数，一种标识程序性能的度量单位。表示执行了多少条指令


- 循环的低效率，一个函数A在实现内部调用另一个函数B作为一个for循环的条件，每次循环都必须对测试条件进行求值。在函数B的值返回不会随着循环进行而改变时，当循环次数足够大时会大大影响程序的运行效率
优化前：

![此处输入图片的描述](http://yatesblog.oss-cn-shenzhen.aliyuncs.com/img/computer-system-Perspective/31.png)

优化后：

![此处输入图片的描述](http://yatesblog.oss-cn-shenzhen.aliyuncs.com/img/computer-system-Perspective/32.png)

- 减少过程调用
优化后：

![此处输入图片的描述](http://yatesblog.oss-cn-shenzhen.aliyuncs.com/img/computer-system-Perspective/33.png)

- 消除不必要的内存引用
优化后：
![此处输入图片的描述](http://yatesblog.oss-cn-shenzhen.aliyuncs.com/img/computer-system-Perspective/34.png)

大量晶体管集成到一块芯片上，现代微处理器采用了复杂的硬件，程序性能得到最大化。在代码级上，似乎是一次执行一条指令，每条指令包括从寄存器或内存取值，执行操作，并把结果存回到一个寄存器和内存位置。实际处理器中，同时对多条指令求值，称为**指令级并行**

- 延迟界限：当一系列操作必须按照严格顺序执行时，就会遇到延迟界限（一条指令必须在前面指令结束后才能执行）。延迟界限会影响程序性能，影响到**吞吐量界限**

- 循环展开：通过增加每次迭代计算的元素的数量，减少循环的迭代次数,也可理解为按情况拆分单个循环结构为多个

- 提高并行性
    - 多个积累变量：对于一个可结合和可交换的合并运算，可以通过将一组合并运算**分割成两个或更多**部分，并在最后合并结果提高性能。
    ![此处输入图片的描述](http://yatesblog.oss-cn-shenzhen.aliyuncs.com/img/computer-system-Perspective/36.png)
    - 重新结合变换：改变原属向量合并的顺序，例如乘法和加法的结合，减少计算中关键路径上操作的数量，更好的利用单元的流水线能力得到更好的性能。（浮点运算不保证时可结合的）
       ![此处输入图片的描述](http://yatesblog.oss-cn-shenzhen.aliyuncs.com/img/computer-system-Perspective/37.png)

**一些限制**

- 循环并行性受到汇编代码描述计算的能力限制，如果我们并行度p超过可用的寄存器数量，那么寄存器会溢出，将某些临时值存放在内存中，逻辑堆栈分配。那么维护多个积累变量迭代优势就会消失。
- 分支预测和预测错误处罚，当分支预测逻辑不能正确预测一个分支是否要跳转的时候，条件分支可能会招致很大的预测错误处罚。现代处理器从内存读取新指令，译码指令，决定在什么操作数上执行什么操作，整个过程就像**指令流水线化**，对于碰到分支时，就要预测分支的跳转地址和过程返回指令，当预测错误时，处理器必须丢弃所有**投机执行**的结果，**重新填充指令流水线**

## 内存性能
- 加载的性能：一个包含加载操作的程序依赖于流水线的能力，也依赖于单元的延迟，一条加载操作的结果决定下一条加载操作的地址。
- 存储的性能：前面加载操作，是从内存位置读到寄存器，而存储操作是将一个寄存器写道内存

## 应用：性能提高
1. 高级设计：为遇到的问题选择适当的算法和数据结构。
2. 基本编码原则
    - 消除连续的函数调用。在可能时，将计算移到循环外。考虑**有选择的妥协程序的模块性以获得更大的效率**
    - 消除不必要的内存引用。映入临时变量来保存中间结果。只有在最后的值计算出来时，才将结果存放到数组或全局变量中。
3. 低级优化
    - 展开循环，降低开销，使进一步优化称为可能。
    - 通过使用例如多个积累变量和重新结合技术，找到方法提高指令级并行
    - 用功能性风格重写条件操作，使得编译采用条件数据传送

**！！！！避免为了提高效率重写程序时避免引入错误**