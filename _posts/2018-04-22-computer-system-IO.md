---
layout: post
title: '深入理解计算机系统-高速缓存器'
subtitle: '读书笔记系列深入理解计算机系统之IO'
date: 2018-04-22
categories: 计算机系统
author: yates
cover: ''
tags: 计算机系统
--


## 前言
输入输出(I/O)是主存和外部设备（磁盘，终端，网络）之间复制的过程。

## Unix I/O
所有语言都提供执行I/O的工具。ANSI C提供标准I/O库，在Linux系统中，通过内核提供系统级I/O库，在Linux系统中，通过内核提供系统级I/O函数。
所哟I/O设备都被模拟为文件，Linux内核提供一个简单，低级的应用接口，通过统一的输入，输出方式来执行。
- 打开文件，应用访问文件，内核返回一个非负整数，标识这个文件，叫做描述符。
- shell创建进程都会打开三个文件，标准输入，标准输出，标准异常
- 改变当前文件地址，每个打开的文件内核都保持一个文件位置k，初始为0.表示从文件开头起始的字节偏移量。
- 读写文件，读操作从文件复制n个字节到内存，从当前文件位置k开始，然后增加k到k+n，给定一个m字节的文件，当k>m时读操作触发eof条件；写操作从内存复制n字节到文件，更新k值。
- 关闭文件，当完成访问后，通知内核关闭文件，内核释放文件打开时创建的数据结构，并将描述符恢复到可用的描述符池中。

## 文件
每个linux文件有一个类型表示身份
- 普通文件，包含任何数据，分为文本文件和二进制文件，对内核来说没有区别。
- 目录，包含一组链接的文件，每个链接映射到一个文件。每个目录至少有两个条目,"."和“..”分别表示自身链接和上一级目录链接
- 套接字，用来和另一个进程进行通信的文件
- 还有例如，命名通道，符号链接，字符和块设备等

内核组织所有文件位一个额目录层次结构，每个文件都直接或间接是根目录的后代。目录之间通过绝对路径名和相对路径名

**不足值**
linux内核打开，关闭，读写文件都以不同函数，不同参数来进行，有些情况下，read读函数和wirte写函数传送字节比应用程序要求的少，称为不足值。
- 在读中可能会遇到EOF，比如读取只含20字节文件，以50字节读取，当读到20时read返回不足值0发出EOF信号
- 终端读取文本行，read函数一次传送一个文本行，不足值代表文本行大小
- 读写网络延迟时会返回不足值

**RIO**
通过RIO自动处理上面的不足值，RIO提供两类函数
- 无缓冲输入输出函数，直接在内存和文件之间传送数据，没有应用级缓冲。多用于读写网络中数据
- 带缓冲输入函数。提供应用级缓冲区，多用于文件中读取文本行和二进制数据。

除此外linux海通，读取文件元数据，读取目录和内容，以及I/O重定向的函数

java，c等语言基于Unix I/O的实现，提供了比Unix I/O更高级别的代替，更简单，但是由于标准I/O和网络文件一些互不相容的限制，Unix I/O比标准I/O更适合网络应用程序。

## 网络编程

### 客户端-服务器编程模型
每个网络应用都是基于**客户端-服务器模型**，一个应用由一个服务器**进程**和一个或多个客户端**进程**组成。服务器管理资源，通过**操作资源**来为客户端提供服务。
客户端-服务器模型中级别操作是事务。由以下四步组成：
1. 客户端需要服务时，向服务器发送请求，发起一个事务。
2. 服务器收到请求，解释它，并以适当方式操作资源。
3. 服务器给客户端发送一个响应，并等待下一个请求
4. 客户端收到响应并处理它

对主机而言，网络只是一种I/O设备，从网络上接收到的数据从适配器经过I/O和内存总线复制到内存。反之也能复制到网络。

物理上而言，网络是一个按照地理远近组成层次系统。最低层是LAN（局域网），最流行**局域网**技术是**以太网**，一个以太网段包括一些电缆（双绞线）和一个叫做集线器的小盒子，每根电缆由相同的最大**位带宽**，一端连接主机适配器，另一端连接集线器一个端口，集线器将收到的数据复制到其他端口进行发送。每个主机适配器都有全球唯一48位地址，每个主机发送以**帧**为单位的数据到这个网段上其他任何主机，**帧**包括一些固定数量**头部，标识源和目的，帧长度，有效载荷**，每个主机适配器都能看到这个帧，但只有目的主机读取它。

![此处输入图片的描述](http://pev96mxgw.bkt.clouddn.com/img/computer-system-Perspective/20.png)

以太网段通过电缆和网桥连接位较大的局域网，称为**桥接以太网**

![此处输入图片的描述](http://pev96mxgw.bkt.clouddn.com/img/computer-system-Perspective/21.png)

在更高层次中，多个不兼容局域网可通过叫做路由器特殊计算机连接起来，组成互联网络

互联网络很重要特性是，由**不同和不兼容技术各种局域网和广域网**组成，每台主机和每台主机都是物理相连，他们之间能够**不互斥的进行数据传输**依靠的是**遵守相同的协议**软件。
协议应该具备级别能力

- 命名机制，不同的局域网技术在为主机分配地址时具有一种**一致的主机地址格式**

- 传送机制，通过定义一种把数据**捆扎成不连续的片(称为包)**的统一方式，来消除**不同联网技术对帧的封装的不同方式**，一个包由**包头和有效载荷**组成，包头包括**包大小**和**源主机**和**目的主机**地址,互联网络思想精髓时**封装**

主机和路由器通过相同协议在不兼容局域网间传送数据，如图：

![此处输入图片的描述](http://pev96mxgw.bkt.clouddn.com/img/computer-system-Perspective/22.png)

1. 位于主机A的客户端进行系统调用，将数据从虚拟地址空间复制到内核缓冲区
2. 主机A的协议软件在传输数据前附加**网络包头和LAN1帧头**，创建LAN1的帧。LAN1帧头寻址到路由器，然后传送帧到适配器。LAN1帧有效载荷时互联网包，而互联网包有效载荷是实际用户数据。
3. LAN1适配器复制到该帧到网络上
4. 当帧到达路由器时，路由器LAN1适配器从电缆读取，并传送到协议软件
5. 路由器从互联网包头中提取出目的地址，作为路由表索引，决定向哪里转发该包，剥落旧的LAN1帧头，封装为新的LAN2帧头，并把帧传送到适配器。
6. 路由器LAN2适配器复制该帧到网络上
7. 当此帧到达主机B时，适配器从电缆读到此帧，并传送到协议软件。
8. 最后主机B剥落包头，帧头，读取数据到到虚拟地址空间

因特网客户端和服务器混合使用**套接字接口函数和Unix I/O函数**进行通信，套接字实现为系统调用，陷入内核，并调用各种内核模式的TCP/IP函数。

**TCP/IP**是现代计算机都支持的协议，IP协议提供基本**命名方法**和**递送机制**。TCP是建立在IP上的复杂协议，提供进程间可靠的全双工连接。

不同主机有不同主机字节顺序，TCP/IP为任意整数数据项定义统一网络字节顺序，如**IP地址**总是使用**大端法**进行存储，解析

ip地址很难记住，我们通常使用域名来代替。域名集合形成一个层次结构

![此处输入图片的描述](http://pev96mxgw.bkt.clouddn.com/img/computer-system-Perspective/23.png) 

因特网定义了域名集合和IP地址间映射，很久以前是通过HOSTS.TXT文本文件手工维护。以后通过分布世界范围内的数据库DNS
进行维护，每个DNS由上百万主机条目。

主机之间的通过连接发送和接收字节流来通信，从连接一对进程意义上而言，连接是点对点的。**套接字**是连接的端点。每个套接字都有地址，由因特网地址和一个16位整数接口组成，用**“地址：端口”**表示。当发起连接请求时，内核**自动分配客户端**套接字地址中端口，而**服务器**套接字地址中端口是**知名端口**，一个连接由两端套接字地址唯一确定，叫做**套接字对**

套接字接口是一组函数（socket，connect，bind，listen，accept），它们和Unix I/O函数结合起来创建网络应用，linux提供函数将主机名，主机地址，服务名，端口号的字符串表示转化成套接字地址结构


