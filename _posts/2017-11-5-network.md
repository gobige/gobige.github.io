---
layout: post
title: '计算机网络之协议森林'
subtitle: 'web开发常见的计算机网络协议'
date: 2017-11-05
categories: 计算机网络
author: yates
cover: 'http://cctv.com'
tags: 计算机网络
---

# 协议模型
**OSI七层协议模型**

OSI七层协议模型分为应用层，表示层，会话层，传输层，网络层，数据链路层，物理层

**TCP/IP模型**
TCP/IP模型分为应用层，传输层，网络层，数据链路层

**TCP/IP模型和OSI七层协议模型对应关系**

![此处输入图片的描述](http://yatesblog.oss-cn-shenzhen.aliyuncs.com/img/2017-11-05-network/1.png)


## 链路层
直接的0和1电信号是没有意义的，所以以字节为单位进行**电信号分组**，以太网规定**一组电信号**就是**一个数据包**，用**帧**表示，

数据包的结构

- **首部**:包含目标**MAC地址**（固定14字节,MAC地址是具有网卡的物理机唯一身份标识；）和**类型**。
- **数据**：数据最短46字节，最长1500字节，所以如果数据过长，则要进行**分帧传输**
- **尾部**：固定为4个字节，表示数据帧校验序列

数据链路层的工作就是，对电信号进行分组传输，然后当数据到达子网后，以太网通过**广播**的形式，发送数据给所有主机，主机通过匹配数据首部的**MAC地址**,得到数据。**以太网和WiFi是链路层的两种协议**。

## 网络层
在网络层里，有三个很重要的协议，IP协议，ARP协议，路由协议

**IP协议**

网络层通过应用层传入的ip来进行主机的寻址，ip地址分为IPV4和IPV6，IPV4前面部分代表**网络地址**，后面部分代表**局域网中地址**，如果两个IP地址在**同一个子网**内，**网络地址一定相同**。

**特点**

- 不可靠：不能保证IP数据包成功到达目的地。
- 无连接：IP不维护后续数据报状态信息，每个数据报处理相互独立，IP数据报无顺序，无固定路由路线。

**IP首部**

- 版本（4bit）：协议版本号，ipv4/ipv6
- 首部长度（4bit）：首部占32bit的数目。4 * 15首部最长60字节
- 服务类型（8bit）：3bit-优先权；4bit：最小时延；最大吞吐量；最高可靠性；最小费用（是否优化由路由器决定）
- 总长度（16bit）：65536
- 标识（16bit）：IP标识，序列由操作系统决定，用于中间分片后收集合成
- 标志（3bit）：DF：没有分片；MF：更多分片
- 片移量（16bit）：根据偏移量将IP数据包整合到一起
- 生存时间（8bit）：TTL，没经过一个路由器 减 1;可以防止环路
- 协议（8bit）:下一个协议是什么 TCP/UDP
- 首部检验和（16bit）：校验数据包完整性
- 源IP地址（32bit）:
- 目的IP地址（32bit）：
- IP选项：记录路径（每个经过路由器IP地址），时间戳（每个经过路由器IP地址和时间），宽松源站选路（必须经过指定路径），严格源站选路（只能经过指定路径）


**特殊IP地址**

****



**子网掩码**
IP地址和子网掩码通过**按位与**运算后就可以得到网络地址

#### **ARP协议**

设备驱动程序从不检查IP数据报中的目的IP地址。

知道主机的IP地址并不能让内核发送一帧数据给主机，ARP功能是在32bit的**IP地址和采用不同网络技术的硬件地址之间提供动态映射**


首先ARP**请求目标主机IP地址**，到达数据链路层后，**子网内主机**借助链路层以太网协议**二层群播**子网主机,主机根据数据包IP地址进行**匹配**，匹配到后就**二层单播**回应ARP返回自己MAC地址，以此确定目标机MAC地址，并缓存IP和MAC的映射关系，下次请求节约寻址时间。arp -a查询本机缓存的映射

在没有得到IP与目的主机MAC绑定关系时，网络中只会有ARP包，不会有IP包。


**ARP结构**

- 以太网首部
	- 以太网目的地址：
	- 以太网源地址：
- ARP请求/应答
	- 硬件类型：1-以太网
	- 协议类型：0800-IP
	- 操作码：1-ARP请求 2-ARP回应
	- 发送以太网地址，发送端IP地址
	- 目的以太网地址，目的以太网IP地址



**ARP代理**

让 **no ip routing**的路由器或也能通过其他开启**ARP代理**的路由器 向目的主机发送包。**返回MAC地址是代理路由器MAC地址**。比如防火墙对外返回防火墙MAC地址，对内代理。


**缺点**

因为ARP响应有后来响应优先特点，所以在形成环路的环境下，代理ARP会造成MAC解析错误，环路问题

未开启代理路由器，只会响应直连网络响应


**免费ARP**

自己问自己IP地址时多少，主要判断是否有IP重叠的问题

免费ARP广播其他主机，会导致主机更新ARP映射，如果是非法攻击行为，导致ARP劫持

#### **ICMP**

传递差错报文以及其他需注意的信息，检验和字段覆盖整个ICMP报文。

 
 
## 传输层

**作用**

**定义端口，标识应用程序，实现端到端**的通信

**UDP协议**

群发数据到主机所有应用中，UDP协议是没有确认机制的

**构成**：

- **首部**：8个字节，**包括源端口和目标端口**
- **数据**：
 
**TCP协议**

面向连接，**可靠**，基于**字节流**的通信协议。通过建立三次握手，四次挥手的**确认机制**来保证数据的安全，可靠性。TCP数据包是**没有长度限制**的，但是一般情况下是不会超过IP数据包的长度。

- 三次握手 
	- 请求方发送数据端（以下简称请求方）**发送连接请求**,附带随机序列号X，
	- 接受数据端（以下简称接受方）接受连接后**回复ACK报文**，递增序列号X，随机生成序列号y，说明已经准备好接受数据了，
	- 请求方收到ack后向接受方**再次发送ACK报文**，递增序列号x，y。说明好的我知道你准备好了。那么这样就建立起连接了

**序列号保证了数据按顺序传递**

- 四次挥手 
	- 当请求方数据发送完后，确定要关闭连接时，向接受方**发送FIN报文**，
	- 接收方获取到FIN后如果发现还有一部分数据没有传输，则会**回应一个ack**给请求方表示你的ack我收到了，但是请等待我的消息，
	- 这时候请求方进入FIN_wAIT状态，当接受方确定数据发送完后，就会**发送FIN报文**，
	- 请求方收到后就知道接收方已经准备好关闭连接了，**再次发送ACK消息**，进入TIME_WAIT(如果发送失败则重传)，接收方收到ACK后就断开连接，而请求方等待一段时间后，没有收到回复，那么请求方就关闭连接,


流量控制：接收方确认数据时，将缓冲区大小发回发送方。发送方控制发送流量
拥塞控制：发送方维护一个拥塞窗口，表示无需确认可以发送未完成数据总数。连接建立，初始化，拥塞窗口大小为系统默认值，当发送方检测到超时错误时，会减少拥塞窗口大小，反之，增加。有效保护了网络基础带宽


**sliding window**

对于发送方来说，滑窗的左侧为已发送并已ACK过的片段序列，滑窗右侧是尚未发送的片段序列。滑窗中的片段(比如片段5，6，7)被发送出去，并等待相应的ACK。如果收到片段5的ACK，滑窗将向右移动。这样，新的片段从右侧进入滑窗内，被发送出去，并进入等待状态。在接收到片段5的ACK之前，滑窗不会移动，即使已经收到了片段6和7的ACK。这样，就保证了滑窗左侧的序列是已经发送的、接收到ACK的、符合顺序的片段序列

## 应用层

将字节流数据通过HTTP,FTP,SMTP等协议转换为能够识别的格式，json,xml等。

应用层工作就是定义数据并按照对应**格式进行解析**
 


# 数据如何传输

当你输入一个网址并按下回车键的时候，首先，应用程序对该请求包做了格式定义；紧接着传输层协议加上了双方的端口号，确认了双方通信的应用程序；然后网络协议加上双方IP地址，确认了双方的网络位置；最后链路层协议加上双方的MAC地址，确认了双方的物理位置，同时将数据进行分组，形成数据帧，采用广播形式，通过传输介质发送到对方主机
  