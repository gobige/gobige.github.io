---
layout: post
title: '深入理解计算机系统-存储器层次结构'
subtitle: '读书笔记系列深入理解计算机系统之存储器层次结构'
date: 2018-04-14
categories: 计算机系统
author: yates
cover: ''
tags: 计算机系统
---

# 前言
存储器系统是一个具有**不同容量，成本和访问时间**的存储设备的层次结构。高层次相对于低层次的存取效率更高一些，但是每个比特位更贵一些。

## 随机访问存储器
随机访问存储器（RAM）分为两类：静态和动态。静态比动态更快，但也更贵。**SRAM用来作为高速缓存存储器，经常位于cpu上或左右**；**DRAM用来作为主存和图形系统帧缓冲区**。

### 静态RAM
SRAM将每个bit存储在一个双稳态单元，这个单元由六个晶体管组成，**存储密度不高，存储数据有限**,始终在任何时候都只有两个稳定的配置和状态。**电路简单**，所以**访问速度快**，但是一旦**断电，数据就会丢失**。

### 动态RAM
DRAM将每个位存储为对一个电容的**充电**，每个单元由**一个电容和一个访问晶体管**组成。其特点时对干扰敏感，当电容电压被扰乱后，永远不会恢复，内存系统通过**周期性的读出，重写刷新内存(充电)**每一位或使用纠错码来保证进行纠正，存储密度更大，电路比SRAM复杂，访问延时更长。

**传统DRAM**
DRAM芯片中单元（位）被分成d个超单元，每个超单元由W个DRAM单元组成。超单元被组织成一个r行c列的长方形阵列.如图：

![此处输入图片的描述](http://yatesblog.oss-cn-shenzhen.aliyuncs.com/img/computer-system-Perspective/11.png)
这是一个16x8的DRAM芯片组织，16个超单元，每个单元8位。信息通过**引脚**流入流出，每个引脚携带一个位。下图由2个地址引脚，8个数据引脚，其他控制信息引脚未给出。每个DRAM芯片被连接**内存控制器**的电路，这个电路一次传送w位到每个DRAM芯片或从芯片读取w位。

首先，通过传送2位addr地址获取指定行所有超单元信息，复制到**内部缓冲区**，然后传送2位指定列从内部缓冲区获取指定超单元信息，通过data引脚传送出去，做成行列结构而不是一行可以节省2个引脚，但是需要两次传送addr信息。

**内存模块**
DRAM芯片封装在内存模块中，插到主板的扩展槽上，i7使用240引脚双列直插内存，以64位块作为块传送数据到内存控制器。如图：
![此处输入图片的描述](http://yatesblog.oss-cn-shenzhen.aliyuncs.com/img/computer-system-Perspective/12.png)

该模块用了8个64Mbit的8Mx8DRAM芯片，总共64MB数据，每个超单元存储8位，总共8个芯片8个超单元64位数据，按照高低位排序传输。

**增强DRAM**
- 快页模式，在传统的DRAM模式中因为行缓冲区，用一次后就会丢弃，如果从同一个行读4个超单元，需要发送4次RAS/CAS请求，在快页模式下，行缓冲区得到重复利用，只需要发送一次RAS/CAS和后面跟3个CAS
- 扩展数据输出，允许各个CAS信号在时间上靠的更紧密一点
- 同步DRAM，和内存控制器通信使用一组显式控制信号，最终比一般的异步存储器更快输出超单元内容
- 双倍数据速率同步，使用两个时钟沿作为控制信号，从而使DRAM速度翻倍。
- 视频RAM，用在图形系统帧缓冲区，输出通过依次对内部缓冲区整个内容进行移位和允许对内存并行读和写。

**非易失去性存储器**
如果断电，SRAM和DRAM会失去信息，非易失去性存储器即使在关电后，仍然保持信息。比如ROM只读存储器，ROM通过能够被重写次数和进行重写所用机制进行区分分为可擦写可编程ROM，闪存（固态硬盘）。ROM中存储的程序称为固件。

**访问主存**

数据通过总线在处理器和DRAM主存之间传输。传输过程可分为读事务，写事务。如图：

![此处输入图片的描述](http://yatesblog.oss-cn-shenzhen.aliyuncs.com/img/computer-system-Perspective/13.png)
I/O桥接器负责系统总线电子信号和内存总线电子信号之间的转换

## 磁盘存储

磁盘相比RAM能够存储大量数据，但读数据毫秒级，比DRAM慢10万倍，比SRAM慢100万倍。

### 磁盘构造
磁盘时由盘片构成，每个盘片有两面或称为表面，表面覆盖磁性记录材料。盘中间有可以旋转的主轴，盘片依靠主轴每分钟5400~15000转。磁盘表面由一组称为磁道的同心圆组成，每个磁道划分为一组扇区，每个扇区包含相等数量的数据位（通常512字节），扇区之间由间隙分隔，间隙不存储数据位。描述多个盘片构造经常用柱面来描述，柱面是所有盘片表面上到主轴中心的距离相等的磁道的集合。如图：
![此处输入图片的描述](http://yatesblog.oss-cn-shenzhen.aliyuncs.com/img/computer-system-Perspective/14.png)

### 磁盘容量

磁盘容量由以下因素决定：
- 记录密度：磁道一英寸的段可以放入的位数
- 磁道密度：从盘片中心出发半径一英寸上可以有磁道数
- 面密度：记录密度和磁道密度乘积

**磁盘容量计算公式**

磁盘容量=字节数/扇区 * 平均扇区数/磁道 * 磁道数/表面 * 表面数/盘片 * 盘片数/磁盘

### 磁盘操作

磁盘用读/写头来读写存储在磁性表面的位，读写头连接一个传送臂一端，通过机械臂沿半径前后移动，读写头可以到达盘面任何位置，这种运动称为**寻道**，多个盘片每个盘面都有一个独立读写头，读写头垂直排列，一致行动，任何时候都位于同一柱面上。如图：
![此处输入图片的描述](http://yatesblog.oss-cn-shenzhen.aliyuncs.com/img/computer-system-Perspective/15.png)

读写头和盘面之间高度约为0.1微米，每一粒细小微尘都会使其停下来，所谓**读/写头冲撞**，为此，磁盘总是密封包装的。

- 寻道时间，为了读取某个目标扇区内容，机械臂首先定位内容所在磁道，这个过程花费时间称为寻道时间，这个时间依赖**读写头以前位置和机械臂盘面移动速度**
- 旋转时间，当读写头到达期望磁道，等待目标扇区第一个位旋转到读写头下，这个过程花费时间称为旋转时间，这个时间依赖读写头处于**扇区的位置和盘面旋转速度**
- 传送时间，当目标扇区第一个位位于读写头下，开始读或写扇区内容，，这个过程花费时间称为传送时间，这个时间依赖读写头处于**磁道扇区数目和盘面旋转速度**

上面三个时间加起来就是就是一个**扇区的访问时间**

- **访问磁盘扇区512字节时间主要是寻道时间和旋转延迟**
- **因为寻道时间和旋转延迟时间大致相等，所以寻道时间乘2时合理估计访问时间的方式**
- **存储在SRAM中一个64位字访问时间大约4ns，DRAM需要60ns。SRAM从内存中读512字节块大约256ns，DRAM是4000ns，而磁盘访问要10ms，是SRAM的40000倍，是DRAM的2500倍**

### 逻辑磁盘块

一个B个扇区的逻辑块的序列，编号为0~B-1，磁盘中有一个小的硬件/固件设备，称为磁盘控制器，维护**逻辑块号和实际磁盘扇区之间映射关系**。当操作系统执行I/O操作时，读取数据到内存，操作系统发送命令道磁盘操作器，让读取某个逻辑块号，控制器通过固件执行一个快速表查找对应的以盘面，磁道，扇区三元组的物理地址，读取数据进缓存，然后复制到主存中

### 连接I/O设备

在cpu，内存，外接I/O设备之间都是通过各种类型的总线进行互联的，系统总线和内存总线与CPU有关，诸如PCI这种I/O总线跟底层CPU无关，可以容纳种类繁多的第三方I/O设备。但是比系统和内存总线慢。

常见I/O总线
> - 通用串行总线（USB），通常连接鼠标，键盘，移动硬盘等外设。USB3.0最大带宽525mb/s
- 图形卡，负责代表CPU在显示器上画像素
- 主机总线适配器（SATA,SCSI），将一个或多个磁盘连接到I/O总线，使用特别的主机总线接口定义的协议。

### 访问磁盘
CPU使用一种**内存映射I/O**来向I/O设备发射命令。在使用**内存映射I/O**的系统中，有一块为了和I/O设备通信的专门的地址，每个地址称为一个I/O端口。一个设备总是与一个或多个端口相连。

例子：
> - 磁盘控制器映射到端口0xa0，cpu通过三个对地址0xa0的存储指令，进行磁盘读。
    - 1发送一个读的命令字，同时附带其他参数（读完成是否cpu中断）
    - 2指明读数据的逻辑块号
    - 3指明存储磁盘扇区内容的内存地址
- 指令发出后，cpu继续执行其他指令；磁盘控制器接收到命令后，翻译逻辑块号到物理地址，读取数据到内存中。设备可以执行读或写总线事务，不需要cpu干涉，这个过程称为直接内存访问。数据传送称为DMA传送。
- DMA完成后，磁盘控制器向CPU发送中断信号，CPU收到信号后，暂停当前工作，跳转到一个操作系统例程，记录下I/O已完成，然后控制返回给暂停中断的地方

### 固态硬盘
SSD是一种基于闪存的技术。SSD封装到I/O总线上的USB或SATA插槽，一个SSD由一个或多个闪存芯片和闪存翻译层组成。
闪存芯片代替传统旋转磁盘机械驱动器；闪存翻译层是一个硬件/固件设备，对应磁盘控制器。

![此处输入图片的描述](http://yatesblog.oss-cn-shenzhen.aliyuncs.com/img/computer-system-Perspective/16.png)

如上图：一个闪存由B个块组成，每个块由P（32~128）页，一页大小512字节~4KB,每个块16KB~512KB。数据以页为单位读写。每个页只有在所属块被擦除（全置为1）才能重新写。大约100000次重复写后块就会损坏，永久不能使用。

![此处输入图片的描述](http://yatesblog.oss-cn-shenzhen.aliyuncs.com/img/computer-system-Perspective/17.png)
随机写很慢原因

1. 擦除块需要相对长时间 ms级 
2. 写一个已经有数据（不全为1）的页，这个块中数据会复制到另一个块中。

## 局部性
- 时间局部性 具有良好时间局部性的程序中，一个被引用过一次的内存位置在不远的将来再**被多次引用**
- 空间局部性 具有良好空间局部性程序中，，一个被引用过一次的内存位置在不远的将来**引用附近的一个内存位置**

上述倾向被称为局部性原理，上述两者有其一，我们就称为程序具有良好局部性。具有良好局部性的程序比局部性差的程序运行得快。在**硬件层**，计算机设计者通过引入称为**高速缓存存储器**来保存**最近被引用的指令和数据项**；在**操作系统级**，系统使用**主存**作为虚拟地址空间最近被**引用块**的高速缓存。

**例子**
我们程序中常使用的数组，当我们访问数据时，通过下标来进行数据访问，且数组中每个元素之间步长为1，称为引用模式。**随着步长增长，空间局部性下降**。在一个for循环程序中使用的取指令，指令被执行多次情况下，具有良好的时间局部性。而这些指令从内存中读出，cpu很少会重写或修改这些指令。

- 重复引用相同变量的程序有良好的时间局部性
- 步长小的引用模式程序空间局部性好
- 循环体越小，循环次数越多，局部性越好

**IOPS,DTR**

![此处输入图片的描述](http://yatesblog.oss-cn-shenzhen.aliyuncs.com/img/computer-system-Perspective/54.png)

- Acc.Time：响应时间
- Seq:属性读写吞吐率
- 4K：随机写入4K数据吞吐率
- 4K-64Thrd：随机64个16MB测试文件读写

顺序读写和随机读写，硬盘性能不一样的，但是随机读写不管是SATA3.0接口还是PCI Express接口，性能差异很小。
我们从benchmark工具中可以看到硬盘的读写测试情况。其中有个4K的指标，我们拿读写的数据比如40MB/s,除以4KB得到就是
每秒读写的次数（**IOPS，普通HDD硬盘随机IOPS也就100次**）

### IO_WAIT
CPU一秒执行指令数，和硬盘能够进行操作数，有好几个数量级差异，这样会造成CPU等待I/O操作完成。也就是**io_wait**

**IO_WAIT定位**

- top指令：在%Cpu行看wa指标的百分比
- iostat：查看硬盘当前运行情况，tps就是IOPS情况
- iotop：查看具体哪个进程占用大量I/O


## 存储器层次结构

![此处输入图片的描述](http://yatesblog.oss-cn-shenzhen.aliyuncs.com/img/computer-system-Perspective/18.png)
各个存储器之和**相邻**的一层存储器打交道，并随着一层层向下，存储器**容量逐层增大**，**访问速度逐层变慢**，单位**存储成本逐层下降**

**存储器层次结构中心思想**：位于k层的**更小更快设备**作为位于k+1层**更大更慢的存储设备**的缓存。在任何时候第k层缓存包含第k+1层块的一个**子集的副本**。

数据总是以块作为传送单元来进行传输，层次之间除开相邻层次之间每块大小是固定的以外，其他层次之间有不同的块大小。

**缓存命中**
当我们需要在k+1层某个数据对象d时，先在第k层查找d，如果d刚好在k层，那么称为缓存命中。

**缓存不命中**
反之，如果没有在k层中找到，我们称为缓存不命中。当发生缓存不命中时，从第k+1层中**取出需要的数据**对象,**放入** k层当中，如果k层满了，则**覆盖**一个块，覆盖的策略通常是**最少使用策略(LRU)**

### 缓存不命中的种类
- 冷不命中 当k层缓存是空的时候，任何数据对象访问都不会命中，一个空的缓存称为**冷缓存**，此类命中称为**强制性不命中或冷不命中**，此类缓存是短暂的
- 冲突不命中 当发生不命中，需要从k+1获取数据块到k层，随机放置块，定位代价高，硬件缓存使用严格的放置策略，将k+1层某个块a放置第k层块b中一个**小的子集**中，当a中数据交替覆盖块b时，称为冲突不命中。
- 容量不命中  在一系列**阶段**（如循环）中，每个阶段访问缓存块**某个相对稳定不变集合**，这个集合称为**工作集**。当工作集大小超过缓存大小时，缓存会经历容量不命中

### SSD

ssd使用电容加上电压计组合在一起，记录一个或多个比特

SSD通过不同电压一个存储单元可以存放多位数据
 
 **SSD结构**
 
 - Die裸片：多个裸片叠在一起
	- plane平面：多个平面位于裸片上，一个平面擦除大概GB基本
		- Block块：多个块位于平面上，一个块通常几百KB到几MB大小
			- Page页：多个页位于一个块上，一个页大小通常4KB
 
 
SSD的数据写入不能像机械硬盘一样通过覆写，而是先去擦除。读取基本单位不是byte而是一个页。擦除按照块来擦除，
SSD使用寿命是每一个**块的擦除的次数**，次数在几千次到10w次之间。所以SSD适合读多写少的应用。一般装机作为系统盘，而不是文件盘

**磨损均衡，TRIM和写入放大效应**


- **磨损均衡**：平常使用SSD情况下，我们并不知道各个块目前擦写的情况和寿命，为了延长使用寿命，让SSD硬盘各个块擦除次数，均匀分摊到各个块上。
- **闪存转换层**:通过FTL里存放逻辑块地址到物理块地址的映射，根据每个物理块磨损程度，动态修改映射，不用考虑块的磨损程度

我们在操作系统删除处于HDD的一个文件，并没有真的在物理层删除这个文件，只是在文件系统里，把对应inode元消息清理掉，这也就是为什么删除了的文件还能找回的原因。但是由于
SSD的磨损均衡，在搬运很多已经删除了的数据。造成不必要数据读写，和擦除。

- **TRIM指令**：文件在删除的时候，让操作系统通知SSD硬盘，对应逻辑块已经标记已删除。

- **写入放大** ：实际闪存写入数据量/系统通过FTL写入的数据量=写入放大，写入放大越大说明SSD性能越差。为了解决这个问题，定时在后台进行垃圾回收。


**AeroSpike**
AeroSpike专门针对SSD硬盘设计的key-value数据库。它直接操作SSD里的块，

- 写入数据尽可能写比较大的数据库；读数据时则无限制。
- 持续进行碎片整理，一旦物理块碎片超过50，就进行压缩搬运，然后数据擦除
- 官方建议只用标定SSD硬盘容量一半，以确保写放大效应尽可能小

### DMA

在内存和I/O设备的数据传输，不再通过CPU控制数据传输，而是通过DMA控制器芯片。

**DMAC数据传输过程**

从不同角度，相对CPU和其他IO设备而言，DMAC即使主设备也是从设备。

- CPU发起向DMACA设备发起请求，请求携带信息：1原地址初始值以及传输时地址增减方式 2.目标地址初始值以及传输时地址增减方式 3传输数据长度
- 如果从硬盘往内存加载数据，硬盘通过额外连线向DMAC发起请求
- DMAC响应请求，向硬盘发起读数据请求，读到DMAC控制器
- DMAC向内侧发起总线写请求，数据写入内侧
- 重复搬运数据动作
- DMAC变成空闲状态


![此处输入图片的描述](http://yatesblog.oss-cn-shenzhen.aliyuncs.com/img/computer-system-Perspective/55.png)















